<!-- TODO:  -->
<!-- TODO: screen clear?  -->
<!-- TODO: color picker  -->
<!-- TODO: more colorful  -->
<!-- TODO: enable [] array of pixels -->
<!-- TODO: update readme -->
<!-- TODO: add storage retrieval -->
<!-- TODO:  -->
<!-- TODO:  -->
<!-- TODO:  -->
<!-- TODO:  -->
<style>
body, html, div {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #222;
    outline: none;
    border: none;
    gap: 0;
    row-gap: 0;
    column-gap: 0;
}
div#divs {
    display: grid;
    grid-template-columns: repeat(100, 1%);
    width: 100vw;
    height: 100vh;
    touch-action: none;
}

div#divs div {
    margin: -1px;
    background: #222;
}
</style>

<div id=divs>
    <!-- Divs appear here dynamicaly -->
</div>

<script src=pubnub.js></script>
<script>
const userId  = `userId-${Math.random()}.${Math.random()}`;
const channel = 'one-million-divs';
const pubnub  = PubNub({userId: userId});
const divs    = document.getElementById("divs");
const color   = `#${rngHex()}${rngHex()}${rngHex()}`;
let cacheArr;
const rainbowStep = 0.05



function makeRainbow(rainbowStep) {
    let t = 0;
    return function () {
        t += rainbowStep;

        const r = Math.sin(t) * 127 + 128;
        const g = Math.sin(t + 2 * Math.PI / 3) * 127 + 128;
        const b = Math.sin(t + 4 * Math.PI / 3) * 127 + 128;

        return (
            `#${Math.round(r).toString(16).padStart(2, "0")}${Math.round(g).toString(16).padStart(2, "0")}${Math.round(b).toString(16).padStart(2, "0")}`
        );
    };
}
const nextColor = makeRainbow(rainbowStep);


function rngHex() {
    return (Math.ceil(Math.random()*128)+127).toString(16);
}

function broadcast(index, color) {
    pubnub.publish({
        channel : channel,
        message : {
            index : index,
            color : color,
        },
    });
}
pubnub.subscribe({
    channel: channel,
    messages: (msg) =>
        colorize(msg.index, msg.color),
});

let lastIndex = -1;
function motion(event) {
    event.preventDefault();

    // Get div index ID
    const index = getIndex(event);
    if (index < 0) return false;

    // Prevent dupliate transmissions
    if (lastIndex == index) return false;
    lastIndex = index;

    const color = nextColor()

    // Transmit and colorize locally
    broadcast(index, color);
    colorize(index, color);
    return true;
}


function colorize(index, color) {
    const target = cacheArr[index];
    target.style.backgroundColor = color;
}

function getIndex(event) {
    const target = document.elementFromPoint(event.clientX, event.clientY);
    return cacheArr.indexOf(target)
}

let divOffest = 0;
function addMoreDivs(count=10000) {
    for(let i = 0; i<count; i++) {
        let div = document.createElement('div');
        divs.appendChild(div);
    }

    cacheArr = Array.from(divs.children);
}
addMoreDivs();

divs.addEventListener('pointerdown', motion);
divs.addEventListener('pointermove', motion);
</script>
